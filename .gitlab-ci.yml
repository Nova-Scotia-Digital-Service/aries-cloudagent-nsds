image: harbor.novascotia.ca/cts/devops-cicd:latest

variables:
  REGISTRY_HOST: harbor.novascotia.ca
  ACA_PY_VERSION: py36-1.15-1_0.6.0
  CONTAINER_BUILD_IMAGE: ${REGISTRY_HOST}/digitalplatformservices/identity/aries-cloudagent-nsds:${ACA_PY_VERSION}-${CI_COMMIT_SHORT_SHA}
  CONTAINER_PROD_IMAGE: ${REGISTRY_HOST}/digitalplatformservices/identity/aries-cloudagent-nsds:${ACA_PY_VERSION}
  POSTGRE_PACKAGE_URL: https://git.novascotia.ca/api/v4/projects/14/packages/generic/indy-sdk-postgres/1.0.0/libindystrgpostgres.so


stages:
  - build

build-aries: 
  image: ${REGISTRY_HOST}/cts/dind:latest
  stage: build
  script:
   - echo ${REGISTRY_TOKEN} | docker login -u robot\$GitLab --password-stdin ${REGISTRY_HOST}
   - echo "building ${CONTAINER_BUILD_IMAGE}"
   - docker build -t ${CONTAINER_BUILD_IMAGE} . 
   - echo "Pushing to Container Registry ${CONTAINER_BUILD_IMAGE}"
   - docker push ${CONTAINER_BUILD_IMAGE} 
   - echo "building ${CONTAINER_PROD_IMAGE}"
   - docker build -t ${CONTAINER_PROD_IMAGE} . 
   - docker push ${CONTAINER_PROD_IMAGE}

